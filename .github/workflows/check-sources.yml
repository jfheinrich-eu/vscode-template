name: Devcontainer & Scripts Security and Best Practices

on:
  pull_request:
    paths:
      - "devcontainer.json"
      - "setup-template.sh"
      - "scripts/**"
  workflow_dispatch: {}

# Minimal permissions required
permissions:
  contents: read

env:
  SHFMT_VERSION: "v3.10.0"

concurrency:
  group: devcontainer-security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-files:
    name: Check required files
    runs-on: ubuntu-latest
    outputs:
      devcontainer_exists: ${{ steps.check-devcontainer.outputs.exists }}
      hadolint_target_exists: ${{ steps.check-hadolint.outputs.exists }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: check-devcontainer
        name: Check for .devcontainer/devcontainer.json
        run: |
          set -euo pipefail
          if [ -f ".devcontainer/devcontainer.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - id: check-hadolint
        name: Check for Dockerfile (example target for hadolint)
        run: |
          set -euo pipefail
          # passe Pfad an falls dein Dockerfile an anderer Stelle liegt
          if [ -f "Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

  validate-devcontainer:
    name: Validate devcontainer, Dockerfile and scripts
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: check-files
    permissions:
      checks: write
    outputs:
      check_run_id: ${{ steps.create_check.outputs.check_run_id }}
      validation_result: ${{ steps.devcontainer_validate.outcome }}
    if: needs.check-files.outputs.devcontainer_exists == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create a check run (marking start)
        id: create_check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const response = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "Devcontainer & Scripts checks",
              head_sha: context.payload.pull_request ? context.payload.pull_request.head.sha : context.sha,
              status: "in_progress",
              started_at: new Date().toISOString()
            });
            core.setOutput('check_run_id', response.data.id);

      - name: Validate devcontainer.json
        id: devcontainer_validate
        uses: devcontainers/ci@8bf61b26e9c3a98f69cb6ce2f88d24ff59b785c6 # v0.3
        with:
          runCmd: echo "Devcontainer validation successful"

  run-hadolint:
    name: Run hadolint (Dockerfile linter)
    runs-on: ubuntu-latest
    needs: check-files
    outputs:
      hadolint_result: ${{ steps.hadolint.outcome }}
    if: needs.check-files.outputs.hadolint_target_exists == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Run hadolint on Dockerfile
        id: hadolint
        continue-on-error: true
        uses: hadolint/hadolint-action@2332a7b74a6de0dda2e2221d575162eba76ba5e5 # v3.3.0
        with:
          dockerfile: Dockerfile

  shellcheck:
    name: Run shellcheck
    runs-on: ubuntu-latest
    needs: check-files
    outputs:
      shellcheck_result: ${{ steps.shellcheck.outcome }}
      shfmt_result: ${{ steps.shfmt.outcome }}
    steps:
      - uses: actions/checkout@v4
      - name: Install shellcheck & shfmt
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y shellcheck
          # install shfmt: use binary for reliability
          sudo curl -fsSL "https://github.com/mvdan/sh/releases/download/${SHFMT_VERSION}/shfmt_${SHFMT_VERSION#v}_linux_amd64" -o /usr/local/bin/shfmt
          sudo chmod +x /usr/local/bin/shfmt

      - name: ShellCheck scripts
        id: shellcheck
        continue-on-error: true
        run: |
          set -euo pipefail
          files=$(git ls-files -- 'scripts/**' 'setup-template.sh' || true)
          if [ -z "$files" ]; then
            echo "No shell scripts to check"
            exit 0
          fi
          echo "Checking: $files"
          shellcheck -x $files

      - name: shfmt --check
        id: shfmt
        continue-on-error: true
        run: |
          set -euo pipefail
          files=$(git ls-files -- 'scripts/**' 'setup-template.sh' || true)
          if [ -z "$files" ]; then
            echo "No shell scripts to format-check"
            exit 0
          fi
          # Check formatting - shfmt exits with 1 if files need formatting
          if ! shfmt -l -d $files; then
            echo "::error::Shell scripts need formatting. Run: shfmt -w $files"
            exit 1
          fi

  collect-results:
    name: Collect all results
    runs-on: ubuntu-latest
    permissions:
      checks: write
    needs: [check-files, validate-devcontainer, run-hadolint, shellcheck]
    if: always()
    outputs:
      result: ${{ steps.collect.outputs.result }}
    steps:
      - name: Collect results
        id: collect
        run: |
          set -euo pipefail
          STATUS="success"

          # Check validation result (only if job ran)
          if [ "${{ needs.validate-devcontainer.result }}" == "success" ]; then
            if [ "${{ needs.validate-devcontainer.outputs.validation_result }}" != "success" ]; then 
              STATUS="failure"
            fi
          elif [ "${{ needs.validate-devcontainer.result }}" == "failure" ]; then
            STATUS="failure"
          fi

          # Check hadolint result (only if job ran)
          if [ "${{ needs.run-hadolint.result }}" == "success" ]; then
            if [ "${{ needs.run-hadolint.outputs.hadolint_result }}" != "success" ]; then 
              STATUS="failure"
            fi
          elif [ "${{ needs.run-hadolint.result }}" == "failure" ]; then
            STATUS="failure"
          fi

          # Check shellcheck results (only if job ran)
          if [ "${{ needs.shellcheck.result }}" == "success" ]; then
            if [ "${{ needs.shellcheck.outputs.shellcheck_result }}" != "success" ]; then 
              STATUS="failure"
            fi
            if [ "${{ needs.shellcheck.outputs.shfmt_result }}" != "success" ]; then 
              STATUS="failure"
            fi
          elif [ "${{ needs.shellcheck.result }}" == "failure" ]; then
            STATUS="failure"
          fi

          echo "result=$STATUS" >> $GITHUB_OUTPUT

      - name: Update check run (complete)
        if: needs.validate-devcontainer.result != 'skipped'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const checkRunIdStr = '${{ needs.validate-devcontainer.outputs.check_run_id }}';
            if (!checkRunIdStr || checkRunIdStr === '') {
              console.log('No check run ID available to update');
              return;
            }

            const checkRunId = parseInt(checkRunIdStr, 10);
            if (isNaN(checkRunId) || checkRunId <= 0) {
              console.log('Invalid check run ID: ' + checkRunIdStr);
              return;
            }

            const conclusion = '${{ steps.collect.outputs.result }}' === 'success' ? 'success' : 'failure';
            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: checkRunId,
              completed_at: new Date().toISOString(),
              conclusion: conclusion,
              output: {
                title: "Devcontainer & Scripts checks",
                summary: `Checks finished with conclusion: ${conclusion}`,
                text: [
                  `devcontainer.json validation: ${{ needs.validate-devcontainer.outputs.validation_result || 'skipped' }}`,
                  `Dockerfile hadolint: ${{ needs.run-hadolint.outputs.hadolint_result || 'skipped' }}`,
                  `shellcheck: ${{ needs.shellcheck.outputs.shellcheck_result || 'skipped' }}`,
                  `shfmt: ${{ needs.shellcheck.outputs.shfmt_result || 'skipped' }}`
                ].join('\n')
              }
            });

  annotate:
    name: Annotate PR and ensure final status
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    needs: [validate-devcontainer, run-hadolint, shellcheck, collect-results]
    timeout-minutes: 10
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Post PR comment with summary (idempotent)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr || !pr.number) {
              console.log('No PR context to annotate.');
              return;
            }

            // Sanitize inputs to prevent code injection
            const sanitize = (str) => String(str || 'skipped').replace(/[`${}]/g, '');

            const conclusion = sanitize('${{ needs.collect-results.outputs.result }}') || 'failure';
            const devcontainerResult = sanitize('${{ needs.validate-devcontainer.outputs.validation_result }}');
            const hadolintResult = sanitize('${{ needs.run-hadolint.outputs.hadolint_result }}');
            const shellcheckResult = sanitize('${{ needs.shellcheck.outputs.shellcheck_result }}');
            const shfmtResult = sanitize('${{ needs.shellcheck.outputs.shfmt_result }}');

            const body = `## Automated Devcontainer & Scripts checks

            **Overall Status: ${conclusion === 'success' ? '✅ Passed' : '❌ Failed'}**

            | Check | Result |
            |-------|--------|
            | devcontainer.json validation | ${devcontainerResult === 'success' ? '✅' : devcontainerResult === 'skipped' ? '⏭️' : '❌'} ${devcontainerResult} |
            | Dockerfile hadolint | ${hadolintResult === 'success' ? '✅' : hadolintResult === 'skipped' ? '⏭️' : '❌'} ${hadolintResult} |
            | shellcheck | ${shellcheckResult === 'success' ? '✅' : shellcheckResult === 'skipped' ? '⏭️' : '❌'} ${shellcheckResult} |
            | shfmt | ${shfmtResult === 'success' ? '✅' : shfmtResult === 'skipped' ? '⏭️' : '❌'} ${shfmtResult} |

            ${conclusion !== 'success' ? '\n⚠️ Please review the [job logs](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId + ') for details.' : ''}`;

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const botComment = comments.data.find(c => 
              c.user && 
              c.user.type === 'Bot' && 
              c.body && 
              c.body.includes('Automated Devcontainer & Scripts checks')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body
              });
            }

      - name: Fail if checks failed
        if: needs.collect-results.outputs.result != 'success'
        run: |
          echo "::error::One or more checks failed. See job logs for details."
          exit 1
